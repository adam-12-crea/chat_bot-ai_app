<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saisie des Notes - Enseignant</title>
    <link rel="stylesheet" href="/static/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .page-container { max-width: 1400px; margin: 40px auto; padding: 20px; }
        
        /* CONTROLS */
        .controls-card {
            background: rgba(30, 41, 59, 0.95); border: 1px solid #334155;
            padding: 20px; border-radius: 15px; margin-bottom: 20px;
            display: flex; gap: 20px; align-items: end;
        }
        .form-select {
            width: 100%; padding: 12px; background: #0f172a; border: 1px solid #475569;
            color: white; border-radius: 8px; font-size: 1rem;
        }

        /* CM CONFIG PANEL */
        .config-panel {
            background: #1e293b; border: 1px dashed #64748b; padding: 20px;
            border-radius: 10px; margin-bottom: 20px; display: none;
        }
        .weight-row { display: flex; gap: 15px; align-items: center; color: #cbd5e1; margin-bottom: 15px; }
        .weight-input { 
            width: 60px; background: #0f172a; border: 1px solid #475569; 
            color: white; text-align: center; padding: 5px; border-radius: 4px; font-weight: bold;
        }
        
        /* COLUMN MANAGEMENT */
        .col-manager { margin-top: 15px; border-top: 1px solid #334155; padding-top: 15px; }
        .col-tag {
            display: inline-flex; align-items: center; background: #334155; 
            padding: 5px 12px; border-radius: 20px; margin-right: 10px; font-size: 0.9rem;
        }
        .btn-delete-col {
            background: transparent; border: none; color: #ef4444; cursor: pointer;
            margin-left: 8px; font-size: 1rem; transition: 0.2s;
        }
        .btn-delete-col:hover { color: #ffadad; transform: scale(1.2); }

        /* TABLE */
        .grade-table-wrapper {
            background: white; border-radius: 12px; overflow-x: auto; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: none;
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        thead { background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        th { padding: 15px; text-align: left; color: #475569; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; white-space: nowrap; }
        td { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .grade-input {
            width: 60px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px;
            text-align: center; font-weight: bold; transition: 0.2s;
        }
        .grade-input:focus { border-color: #3b82f6; outline: none; background: #eff6ff; }
        .grade-input:disabled { background: #f1f5f9; color: #94a3b8; border-color: transparent; cursor: not-allowed; }

        .role-badge {
            display: inline-block; padding: 5px 12px; border-radius: 20px;
            font-size: 0.8rem; font-weight: bold; margin-left: 10px;
        }
        .role-CM { background: #8b5cf6; color: white; }
        .role-TP { background: #3b82f6; color: white; }

        #saveToast {
            position: fixed; bottom: 20px; right: 20px; background: #0f172a; color: white;
            padding: 12px 25px; border-radius: 30px; display: none; z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 1px solid #334155;
        }
    </style>
</head>
<body>
    <div class="background-overlay"></div>

    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo-container">
                <a href="{{ dashboard_link }}"><img src="/static/uir logo.png" class="logo" alt="UIR Logo"></a>
            </div>
            <div class="user-section">
                <a href="{{ dashboard_link }}" class="header-link"><i class="fas fa-home"></i> Accueil</a>
                <a href="profil.html" class="header-link"><i class="fas fa-user"></i> Profil</a>
                <a href="/api/logout" class="header-link danger-btn"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </div>
    </header>

    <div class="page-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1 style="color:white; margin:0;">üìù Saisie des Notes <span id="roleBadge" class="role-badge" style="display:none"></span></h1>
        </div>

        <div class="controls-card">
            <div style="flex:1;">
                <label style="color:#94a3b8; display:block; margin-bottom:5px;">Classe & Groupe</label>
                <select id="classSelector" class="form-select" onchange="loadTable()">
                    <option value="" disabled selected>Chargement...</option>
                </select>
            </div>
        </div>

        <div id="configPanel" class="config-panel">
            <div style="margin-bottom:15px; font-weight:bold; color:white; border-bottom:1px solid #334155; padding-bottom:10px;">
                ‚öôÔ∏è Configuration Responsable (Total Variable = 50%)
            </div>
            
            <div class="weight-row">
                <div>CF (Fixe): <b>50%</b></div>
                <div>+ CC: <input type="number" id="w_cc" class="weight-input" onchange="validateWeights()">%</div>
                <div>+ Labs: <input type="number" id="w_labs" class="weight-input" onchange="validateWeights()">%</div>
                <div>+ Projets: <input type="number" id="w_proj" class="weight-input" onchange="validateWeights()">%</div>
                <button onclick="saveWeights()" style="padding:6px 15px; background:#22c55e; border:none; border-radius:6px; color:white; cursor:pointer;">Enregistrer Coeffs</button>
            </div>
            <div id="weightError" style="color:#ef4444; font-size:0.9rem; margin-bottom:10px;"></div>

            <div class="col-manager">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="newColName" placeholder="Nom (ex: TP 2, Projet Web)" class="form-select" style="width:250px;">
                    <select id="newColType" class="form-select" style="width:150px;">
                        <option value="lab">Lab</option>
                        <option value="project">Projet</option>
                    </select>
                    <button onclick="addColumn()" style="padding:8px 15px; background:#3b82f6; border:none; border-radius:6px; color:white; cursor:pointer;">
                        + Ajouter
                    </button>
                </div>
                <div id="columnList" style="color:#cbd5e1;"></div>
            </div>
        </div>

        <div class="grade-table-wrapper" id="tableWrapper">
            <table id="gradesTable">
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="saveToast"><i class="fas fa-check-circle"></i> Sauvegard√©</div>

    <script>
        let currentSubjectId = null;
        let currentRole = null; // 'CM' or 'TP'
        let currentData = null; // Store fetched data

        // --- INIT ---
        window.onload = async function() {
            try {
                const res = await fetch('/api/teacher/get_presence_sessions');
                const sessions = await res.json();
                
                const selector = document.getElementById('classSelector');
                selector.innerHTML = '<option value="" disabled selected>-- Choisir une classe --</option>';

                // Add options (CM options will say "Promo Enti√®re", TP options "Group X")
                sessions.forEach(sess => {
                    const opt = document.createElement('option');
                    // Store strict params for backend
                    opt.value = JSON.stringify({ 
                        subject: sess.subject, 
                        group: sess.group, 
                        major: sess.major 
                    });
                    
                    let icon = sess.type === 'CM' ? 'üéì' : 'üß™';
                    opt.innerText = `${icon} ${sess.subject} - ${sess.group} (${sess.type})`;
                    selector.appendChild(opt);
                });

            } catch (e) { console.error(e); }
        };

        // --- LOAD DATA ---
        async function loadTable() {
            const selector = document.getElementById('classSelector');
            if (!selector.value) return;
            const params = JSON.parse(selector.value);

            document.getElementById('tableBody').innerHTML = '<tr><td colspan="10" style="text-align:center; padding:30px;">Chargement...</td></tr>';
            document.getElementById('tableWrapper').style.display = 'block';

            try {
                const res = await fetch('/api/teacher/grading_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                
                const data = await res.json();
                if (data.error) { alert(data.error); return; }

                currentData = data;
                currentSubjectId = data.subject_id;
                currentRole = data.current_role; // 'CM' or 'TP' determined by backend based on selection

                // Update UI Role Badge
                const badge = document.getElementById('roleBadge');
                badge.style.display = 'inline-block';
                badge.className = `role-badge role-${currentRole}`;
                badge.innerText = currentRole === 'CM' ? "Mode Responsable (CM)" : "Mode Tuteur (TP)";

                // Show/Hide Config Panel based on Role
                const cfg = document.getElementById('configPanel');
                if (currentRole === 'CM') {
                    cfg.style.display = 'block';
                    document.getElementById('w_cc').value = data.weights.cc || 0;
                    document.getElementById('w_labs').value = data.weights.labs || 0;
                    document.getElementById('w_proj').value = data.weights.projects || 0;
                    renderColumnList(data.columns);
                } else {
                    cfg.style.display = 'none';
                }

                renderTable(data);

            } catch (e) { console.error(e); }
        }

        // --- RENDER TABLE ---
        function renderTable(data) {
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            
            // 1. Define Visible Columns
            let cols = [];

            // Add Dynamic Columns (Labs/Projects)
            if (data.columns) {
                data.columns.forEach(col => {
                    // Logic: TP can see/edit Labs & Projects. CM can see them but NOT edit.
                    cols.push({ ...col, locked: currentRole === 'CM' }); 
                });
            }

            // Add Fixed Columns (Exams)
            // Logic: Only CM sees exams. TP does not need to see CC/CF.
            if (currentRole === 'CM') {
                cols.push({ id: 'cc', name: 'CC (Exam)', type: 'exam', locked: false });
                cols.push({ id: 'cf', name: 'CF (Final)', type: 'exam', locked: false });
                cols.push({ id: 'ratt', name: 'Rattrapage', type: 'exam', locked: false });
            }

            // 2. Build Header
            let headHTML = '<th>√âtudiant</th>';
            cols.forEach(col => {
                let icon = col.type === 'exam' ? 'üìù' : (col.type === 'project' ? 'üöÄ' : 'üíª');
                headHTML += `<th>${icon} ${col.name}</th>`;
            });
            thead.innerHTML = headHTML;

            // 3. Build Body
            if (data.students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100" style="text-align:center;">Aucun √©tudiant trouv√©.</td></tr>';
                return;
            }

            let bodyHTML = '';
            data.students.forEach(stu => {
                let row = `<tr>
                    <td>
                        <div style="font-weight:bold;">${stu.name}</div>
                        <div style="font-size:0.8rem; color:#64748b;">${stu.id.substr(-6)}</div>
                    </td>`;

                cols.forEach(col => {
                    const val = stu.marks[col.id] || '';
                    row += `<td>
                        <input type="number" 
                               class="grade-input" 
                               value="${val}" 
                               min="0" max="20"
                               data-sid="${stu.id}" 
                               data-col="${col.id}"
                               onblur="saveMark(this)"
                               ${col.locked ? 'disabled' : ''}>
                    </td>`;
                });
                row += '</tr>';
                bodyHTML += row;
            });
            tbody.innerHTML = bodyHTML;
        }

        // --- RENDER COLUMN LIST (FOR DELETION) ---
        function renderColumnList(columns) {
            const list = document.getElementById('columnList');
            list.innerHTML = 'Colonnes actuelles : ';
            
            if (!columns || columns.length === 0) {
                list.innerHTML += "<i>Aucune colonne ajout√©e.</i>";
                return;
            }

            columns.forEach(col => {
                list.innerHTML += `
                <span class="col-tag">
                    ${col.name} (${col.type})
                    <button class="btn-delete-col" onclick="deleteColumn('${col.id}')" title="Supprimer la colonne">
                        <i class="fas fa-trash"></i>
                    </button>
                </span>`;
            });
        }

        // --- ACTIONS ---

        async function saveMark(input) {
            if (input.disabled) return; // Security check
            const val = input.value;
            
            // Allow empty to clear mark, but validate numbers if present
            if (val !== '' && (val < 0 || val > 20)) {
                alert("Note invalide (0-20)");
                input.value = ''; // Reset
                return;
            }

            try {
                const res = await fetch('/api/teacher/save_marks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        subject_id: currentSubjectId,
                        updates: [{ student_id: input.dataset.sid, key: input.dataset.col, value: parseFloat(val) }]
                    })
                });
                const d = await res.json();
                if(d.success) showToast();
            } catch(e) { console.error(e); }
        }

        async function addColumn() {
            const name = document.getElementById('newColName').value;
            const type = document.getElementById('newColType').value;
            if (!name) return alert("Nom requis");

            await fetch('/api/teacher/add_column', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ subject_id: currentSubjectId, name: name, type: type })
            });
            document.getElementById('newColName').value = '';
            loadTable(); // Refresh to see new column
        }

        async function deleteColumn(colId) {
            if(!confirm("‚ö†Ô∏è Attention: Supprimer cette colonne effacera toutes les notes associ√©es pour tous les √©tudiants. Continuer ?")) return;

            await fetch('/api/teacher/delete_column', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ subject_id: currentSubjectId, column_id: colId })
            });
            loadTable(); // Refresh UI
        }

        function validateWeights() {
            const cc = parseFloat(document.getElementById('w_cc').value) || 0;
            const labs = parseFloat(document.getElementById('w_labs').value) || 0;
            const proj = parseFloat(document.getElementById('w_projects').value) || 0;
            const sum = cc + labs + proj;
            
            const err = document.getElementById('weightError');
            if (sum !== 50) {
                err.innerText = `Total actuel: ${sum}% (Doit √™tre 50%)`;
                return false;
            } else {
                err.innerText = "";
                return true;
            }
        }

        async function saveWeights() {
            if (!validateWeights()) return alert("Le total (CC + Labs + Projets) doit √™tre exactement 50%.");
            
            await fetch('/api/teacher/save_config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    subject_id: currentSubjectId,
                    weights: {
                        cc: document.getElementById('w_cc').value,
                        labs: document.getElementById('w_labs').value,
                        projects: document.getElementById('w_projects').value
                    }
                })
            });
            alert("Configuration sauvegard√©e !");
        }

        function showToast() {
            const t = document.getElementById('saveToast');
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }
    </script>
</body>
</html>