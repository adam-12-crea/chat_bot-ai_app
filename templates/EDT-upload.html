<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importation EDT - Administration</title>
    <link rel="stylesheet" href="/static/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .page-container { max-width: 800px; margin: 60px auto; padding: 20px; text-align: center; }
        .upload-panel { background: rgba(30, 41, 59, 0.9); border: 1px solid #334155; border-radius: 20px; padding: 50px; margin-top: 20px; color: white; }
        .drop-zone { border: 3px dashed #475569; border-radius: 15px; padding: 60px 20px; cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.02); }
        .drop-zone:hover { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .file-item { background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; align-items: center; gap: 10px; border: 1px solid #475569; text-align: left; }
        .upload-btn { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 15px 50px; border: none; border-radius: 30px; font-weight: bold; margin-top: 30px; cursor: pointer; display: none; }
        .upload-btn:disabled { background: #64748b; cursor: not-allowed; }
        code { background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 4px; color: #fbbf24; }
    </style>
</head>
<body>
    <div class="background-overlay"></div>
    
    <header class="dashboard-header">
        <div class="header-content">
            <div class="logo-container">
                <a href="{{ dashboard_link }}">
                    <img src="/static/uir logo.png" class="logo" alt="UIR Logo">
                </a>
            </div>

            <div class="user-section">
                <a href="{{ dashboard_link }}" class="header-link">
                    <i class="fas fa-home"></i> Accueil
                </a>
                
                {% if user_role == 'student' %}
                <a href="emploi-temps.html" class="header-link">
                    <i class="fas fa-calendar-alt"></i> Emploi du temps
                </a>
                {% endif %}

                <a href="profil.html" class="header-link">
                    <i class="fas fa-user"></i> Profil
                </a>

                <a href="/api/logout" class="header-link danger-btn">
                    <i class="fas fa-sign-out-alt"></i> DÃ©connexion
                </a>
            </div>
        </div>
    </header>

    <div class="page-container">
        <h1 style="color: white;">Importation Emploi du Temps (Excel)</h1>
        <p style="color: #94a3b8;">Format requis: <code>EDT-{MAJEURE}{ANNEE}-{DATE}.xlsx</code><br>Exemple: <code>EDT-AI4-10OCT-15OCT.xlsx</code></p>

        <div class="upload-panel">
            <form id="uploadForm" onsubmit="handleUpload(event)">
                <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 4rem; color: #22c55e;">ðŸ“Š</div>
                    <h3>Glissez vos fichiers Excel (.xlsx) ici</h3>
                    <input type="file" id="fileInput" hidden multiple accept=".xlsx, .xls">
                </div>
                <div id="fileItemsArea" style="margin-top: 30px;"></div>
                <button type="submit" class="upload-btn" id="submitBtn">ðŸš€ Mettre en ligne</button>
            </form>
        </div>
    </div>

    <script>
        const input = document.getElementById('fileInput');
        const fileItemsArea = document.getElementById('fileItemsArea');
        const submitBtn = document.getElementById('submitBtn');

        input.addEventListener('change', function() {
            fileItemsArea.innerHTML = '';
            if (this.files.length > 0) submitBtn.style.display = 'inline-block';
            
            Array.from(this.files).forEach(file => {
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    fileItemsArea.innerHTML += `
                        <div class="file-item">
                            <span style="font-size:1.5rem">ðŸ“—</span> 
                            <div style="flex-grow:1;"><strong>${file.name}</strong></div>
                            <span style="color:#22c55e;">PrÃªt</span>
                        </div>`;
                } else {
                    alert(`Le fichier ${file.name} n'est pas un fichier Excel valide.`);
                }
            });
        });

        async function handleUpload(e) {
            e.preventDefault();
            if (input.files.length === 0) return alert("Aucun fichier sÃ©lectionnÃ©.");

            submitBtn.disabled = true;
            submitBtn.innerText = 'Traitement en cours...';

            const formData = new FormData();
            for (let i = 0; i < input.files.length; i++) {
                formData.append('files[]', input.files[i]);
            }

            try {
                const res = await fetch('/api/admin/upload_edt', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    alert(`SuccÃ¨s ! ${data.count || 1} fichiers Excel ajoutÃ©s.`);
                    // Redirect back to Admin Dashboard
                    window.location.href = 'admin.html';
                } else {
                    alert("Erreur: " + data.error);
                    submitBtn.disabled = false;
                    submitBtn.innerText = "ðŸš€ Mettre en ligne";
                }
            } catch (err) {
                console.error(err);
                alert("Erreur serveur.");
                submitBtn.disabled = false;
            }
        }
    </script>
</body>
</html>